{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

[ -n "${DEBUG:-}" ] && set -o xtrace
set -o errexit
set -o nounset

# Disable Spotlight's Cmd+Space (HotKey 64)
# Parameters: ASCII 32 (space), virtual keycode 49 (space), modifiers 1048576 (Cmd)
if [ "$(plutil -extract AppleSymbolicHotKeys.64.enabled raw -o - ~/Library/Preferences/com.apple.symbolichotkeys.plist 2>/dev/null)" = "false" ]; then
    echo "Spotlight Cmd+Space already disabled, skipping"
else
    echo "Disabling Spotlight Cmd+Space..."
    defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 64 \
        '<dict>
            <key>enabled</key><false/>
            <key>value</key>
            <dict>
                <key>parameters</key>
                <array>
                    <integer>32</integer>
                    <integer>49</integer>
                    <integer>1048576</integer>
                </array>
                <key>type</key><string>standard</string>
            </dict>
        </dict>'
    /System/Library/PrivateFrameworks/SystemAdministration.framework/Resources/activateSettings -u
    echo "Spotlight Cmd+Space disabled"
fi

# Set Raycast hotkey to Cmd+Space
# Best-effort: may not apply if Raycast is running (cached prefs overwrite on quit)
current="$(defaults read com.raycast.macos raycastGlobalHotkey 2>/dev/null || true)"
if [ "$current" = "Command-49" ]; then
    echo "Raycast Cmd+Space already set, skipping"
else
    echo "Setting Raycast hotkey to Cmd+Space..."
    defaults write com.raycast.macos raycastGlobalHotkey "Command-49"
    echo "Raycast hotkey set"
fi

# Set wallpaper to Monterey Graphic
wallpaper="/System/Library/Desktop Pictures/Monterey Graphic.madesktop"
current_wallpaper="$(osascript -e 'tell application "System Events" to get picture of every desktop' 2>/dev/null | head -1 || true)"
if [ "$current_wallpaper" = "$wallpaper" ]; then
    echo "Wallpaper already set to Monterey Graphic, skipping"
else
    echo "Setting wallpaper to Monterey Graphic..."
    osascript -e "tell application \"System Events\" to set picture of every desktop to \"$wallpaper\""
    echo "Wallpaper set"
fi

# Key repeat: fastest rate (2 = ~30ms) and shortest delay (15 = ~225ms)
if [ "$(defaults read NSGlobalDomain KeyRepeat 2>/dev/null)" = "2" ] \
    && [ "$(defaults read NSGlobalDomain InitialKeyRepeat 2>/dev/null)" = "15" ]; then
    echo "Key repeat already set, skipping"
else
    echo "Setting key repeat rate..."
    defaults write NSGlobalDomain KeyRepeat -int 2
    defaults write NSGlobalDomain InitialKeyRepeat -int 15
    echo "Key repeat set (logout required to take effect)"
fi

# Enable full keyboard navigation (tab through all controls)
if [ "$(defaults read NSGlobalDomain AppleKeyboardUIMode 2>/dev/null)" = "2" ]; then
    echo "Keyboard navigation already enabled, skipping"
else
    echo "Enabling keyboard navigation..."
    defaults write NSGlobalDomain AppleKeyboardUIMode -int 2
    echo "Keyboard navigation enabled"
fi

# Enable Ctrl+scroll to zoom
# com.apple.universalaccess requires sudo; com.apple.Accessibility is user-writable
if [ "$(defaults read com.apple.Accessibility closeViewScrollWheelToggle 2>/dev/null)" = "1" ]; then
    echo "Scroll zoom already enabled, skipping"
else
    echo "Enabling Ctrl+scroll zoom..."
    defaults write com.apple.Accessibility closeViewScrollWheelToggle -bool true
    defaults write com.apple.Accessibility HIDScrollZoomModifierMask -int 262144
    echo "Scroll zoom enabled (logout required to take effect)"
fi

# Clear default Dock icons
if [ "$(defaults read com.apple.dock persistent-apps 2>/dev/null | grep -c 'tile-data')" = "0" ]; then
    echo "Dock already empty, skipping"
else
    echo "Clearing default Dock icons..."
    defaults write com.apple.dock persistent-apps -array
    killall Dock
    echo "Dock cleared"
fi
{{ end -}}
