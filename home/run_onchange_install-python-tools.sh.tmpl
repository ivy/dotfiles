#!/bin/sh

# python version hash: {{ include "dot_config/mise/config.toml" | regexFind "python = \"[^\"]*\"" | sha256sum }}
# python tools requirements hash: {{ include "dot_config/dotfiles/requirements.txt" | sha256sum }}

[ -n "${DEBUG:-}" ] && set -o xtrace
set -o errexit
set -o nounset

# Only run if mise is available
if ! command -v mise >/dev/null 2>&1; then
    echo "mise not found, skipping Python tools installation"
    exit 0
fi

# Only run if Python is available via mise
if ! mise which python >/dev/null 2>&1; then
    echo "Python not available via mise, skipping Python tools installation"
    exit 0
fi

# Get Python path once
PYTHON="$(mise which python)"

echo "Installing Python tools..."

# Use mise's Python to upgrade pip and install pipx
"$PYTHON" -m pip install --upgrade pip pipx

# Install Python tools via pipx from requirements.txt
REQ_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/dotfiles/requirements.txt"
if [ -f "$REQ_FILE" ]; then
  echo "Installing pinned pipx tools from $REQ_FILE..."
  # Ignore comments and blank lines
  grep -Ev '^(#|\s*$)' "$REQ_FILE" | while read -r spec; do
    # --force updates existing venvs when version pins change
    "$PYTHON" -m pipx install --force "$spec"
  done
else
  echo "No requirements.txt found at $REQ_FILE, skipping Python tools installation"
fi

echo "Python tools installation complete"
