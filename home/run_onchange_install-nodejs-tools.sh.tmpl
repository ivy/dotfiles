#!/bin/sh

# bun version hash: {{ include "dot_config/mise/config.toml" | regexFind "bun = \"[^\"]*\"" | sha256sum }}
# node tools manifest hash: {{ include "dot_config/dotfiles/package.json" | sha256sum }}

[ -n "${DEBUG:-}" ] && set -o xtrace
set -o errexit
set -o nounset

# Only run if mise is available
if ! command -v mise >/dev/null 2>&1; then
    echo "mise not found, skipping Node.js tools installation"
    exit 0
fi

# Only run if bun is available via mise
if ! mise which bun >/dev/null 2>&1; then
    echo "bun not available via mise, skipping Node.js tools installation"
    exit 0
fi

# Only run if jq is available
if ! which jq >/dev/null 2>&1; then
    echo "jq not available, skipping Node.js tools installation"
    exit 0
fi

# Get tool paths once
BUN="$(mise which bun)"

echo "Installing Node.js tools..."

# Install Node tools from package.json manifest
MANIFEST="${XDG_CONFIG_HOME:-$HOME/.config}/dotfiles/package.json"
if [ -f "$MANIFEST" ]; then
    echo "Installing pinned tools from $MANIFEST using bun..."
    
    # Extract pkg@version pairs from devDependencies
    jq -r '.devDependencies // {} | to_entries[] | "\(.key)@\(.value)"' "$MANIFEST" | while read -r spec; do
        echo "Installing $spec..."
        # Use bun to install globally
        "$BUN" add --global "$spec"
    done
else
    echo "No package.json found at $MANIFEST, skipping Node.js tools installation"
fi

echo "Node.js tools installation complete"
